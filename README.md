# VNC代理服务器 - 详细使用说明

## 快速开始

### 方式1：运行Python源码（推荐开发者）

1. **安装依赖**
   ```bash
   # 确保已安装uv包管理器
   pip install uv
   
   # 安装项目依赖
   uv pip install pillow>=10.0.0 pystray>=0.19.4
   ```

2. **修改VNC服务端口为：5091**
3. **运行程序**
   ```bash
  
   # 方式1：直接运行Python文件
   python vnc_proxy.py
   
   # 方式2：使用批处理文件
   run.bat
   ```

### 方式2：使用exe文件（推荐普通用户）

1. **构建exe文件**
   ```bash
   # 一键构建（推荐）
   build.bat
   
   # 或手动构建
   python build.py
   ```

2. **运行exe文件**
   - 构建完成后在 `dist` 目录找到 `VNC代理服务器.exe`
   - 双击运行即可

## 系统托盘功能详解

### 托盘图标说明
- 蓝色方块图标表示VNC代理服务器
- 右键点击托盘图标显示菜单

### 托盘菜单选项
1. **显示窗口** - 显示主程序窗口
2. **隐藏窗口** - 隐藏主程序窗口到托盘
3. **启动服务器** - 从托盘直接启动VNC代理服务
4. **停止服务器** - 从托盘停止VNC代理服务
5. **退出** - 完全退出程序

### 托盘使用技巧
- 关闭主窗口时程序会自动最小化到托盘，而不是退出
- 可以完全隐藏程序界面，仅通过托盘操作
- 适合需要长期运行在后台的场景

## 连接管理机制

### 单用户连接控制
- 同时只允许一个VNC客户端连接
- 新客户端尝试连接时会触发决策流程

### 用户决策流程
1. **检测新连接** - 系统检测到新的VNC客户端连接请求
2. **显示决策对话框** - 弹出选择窗口询问用户
3. **用户选择**：
   - "我还要继续使用" - 拒绝新连接，保持当前会话
   - "让新用户连接" - 断开当前连接，允许新用户使用
4. **自动决策** - 5秒无响应则自动允许新用户连接

### 冷却机制
- 被拒绝的客户端IP会进入1分钟冷却期
- 冷却期内该IP无法再次尝试连接
- 避免频繁的连接尝试打扰当前用户

## 高级配置

### 命令行参数
```bash
python vnc_proxy.py [选项]

--vnc-host HOST      # VNC服务器地址（默认：127.0.0.1）
--vnc-port PORT      # VNC服务器端口（默认：5901）
--proxy-port PORT    # 代理服务器端口（默认：5900）
--no-gui            # 不启动GUI界面，纯命令行模式
```

### 配置示例
```bash
# 连接远程VNC服务器
python vnc_proxy.py --vnc-host 192.168.1.100 --vnc-port 5900

# 使用自定义代理端口
python vnc_proxy.py --proxy-port 5902

# 纯命令行模式（服务器环境）
python vnc_proxy.py --no-gui
```

## 网络配置

### 端口说明
- **VNC服务器端口**（默认5900）：原始VNC服务运行的端口
- **代理服务器端口**（默认5901）：客户端连接的端口

### 防火墙设置
确保以下端口在防火墙中开放：
- 代理服务器端口（默认5901）- 供客户端连接
- VNC服务器端口（默认5900）- 供代理连接VNC服务

### 网络架构
```
VNC客户端 -> [代理端口5900] -> VNC代理服务器 -> [VNC端口5901] -> VNC服务器
```

## 日志和调试

### 日志文件
- **文件位置**：`vnc_proxy_simple.log`
- **内容包括**：连接建立、断开、用户决策、错误信息
- **日志级别**：INFO（可在源码中修改为DEBUG）

### 调试模式
修改源码中的日志级别：
```python
logging.basicConfig(level=logging.DEBUG, ...)
```

## 故障排除

### 常见问题及解决方案

#### 1. 端口占用错误
**现象**：启动时提示端口被占用
**解决**：
- 检查是否有其他程序使用了5901端口
- 使用`--proxy-port`参数指定其他端口
- Windows下使用`netstat -an | findstr 5901`检查端口

#### 2. 无法连接VNC服务器
**现象**：客户端连接失败
**解决**：
- 确认VNC服务器正在运行
- 检查VNC服务器地址和端口
- 确认网络连通性

#### 3. GUI界面无法显示
**现象**：程序启动后无界面
**解决**：
- 确认系统支持tkinter
- 检查是否在远程桌面环境
- 使用`--no-gui`参数运行命令行模式

#### 4. 托盘图标不显示
**现象**：看不到系统托盘图标
**解决**：
- 检查系统托盘设置
- 确认任务栏托盘区域设置
- 重启程序

#### 5. exe构建失败
**现象**：build.py运行出错
**解决**：
- 确认Python版本3.8+
- 检查所有依赖是否安装
- 确认有足够磁盘空间

### 获取帮助
- 查看日志文件了解详细错误信息
- 使用命令行参数`-h`获取帮助
- 检查README.md文件中的更新日志

## 最佳实践

### 生产环境部署
1. 使用exe文件部署，避免Python环境依赖
2. 配置适当的日志级别
3. 设置开机自启动（可选）
4. 定期备份配置和日志

### 安全考虑
1. 不要在公网直接暴露代理端口
2. 使用VPN或内网环境
3. 定期检查连接日志
4. 考虑添加认证机制（需要自定义开发）

### 性能优化
1. 根据网络环境调整缓冲区大小
2. 合理设置冷却时间
3. 监控内存和CPU使用情况

## 开发者信息

### 技术架构
- **语言**：Python 3.8+
- **GUI框架**：tkinter
- **网络通信**：socket
- **多线程**：threading
- **系统托盘**：pystray
- **图像处理**：Pillow
- **打包工具**：PyInstaller

### 扩展开发
程序采用面向对象设计，主要类：
- `SimpleVNCProxy`：核心代理类
- 方法模块化，易于扩展功能

### 版本信息
- 当前版本：v1.1.0
- 支持平台：Windows
- Python版本：3.8+